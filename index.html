<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QRIS → GoQR → Base64</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 24px; max-width: 900px; margin: auto; }
    textarea { width: 100%; height: 140px; font-family: monospace; font-size: 13px; padding: 8px; }
    input, button, select { font-size: 14px; padding: 8px; }
    .row { display:flex; gap:8px; align-items:center; margin-top:12px; }
    .result { margin-top:18px; background:#f7f7f7; padding:12px; border-radius:6px; }
    img.qr { max-width:320px; border:1px solid #ddd; padding:6px; background:white; display:block; margin-bottom:10px; }
    pre { white-space:pre-wrap; word-break:break-all; background:#111; color:#bfe; padding:12px; border-radius:6px; font-size:12px; }
  </style>
</head>
<body>
  <h1>Generate QR (GoQR) → Base64</h1>
  <p>Tempel string QRIS di bawah lalu tekan <b>Generate</b>. Contoh string sudah terisi.</p>

  <label for="qrString">QR string (QRIS):</label>
  <textarea id="qrString">00020101021226680016ID.CO.BATPAY.WWW011893600841000000001102150000000000000110303UMI51370014ID.CO.QRIS.WWW0215ID10243568644385204539953033605405230005502015802ID5912Rocket Flash6005BOGOR61051615362510703A01502520250930175922841105083530811Makan Siang63040207</textarea>

  <div class="row">
    <label for="size">Size:</label>
    <select id="size">
      <option value="200x200">200x200</option>
      <option value="300x300" selected>300x300</option>
      <option value="400x400">400x400</option>
      <option value="600x600">600x600</option>
    </select>

    <label for="format">Format:</label>
    <select id="format">
      <option value="png" selected>png</option>
      <option value="svg">svg</option>
    </select>

    <button id="generateBtn">Generate</button>
    <button id="clearBtn" title="Clear result">Clear</button>
  </div>

  <div class="result" id="result" style="display:none;">
    <div id="imageWrap">
      <img id="qrImg" class="qr" alt="QR image" />
    </div>

    <div class="row">
      <button id="downloadBtn">Download PNG</button>
      <button id="copyBtn">Copy data:image/png;base64</button>
      <button id="openNewTabBtn">Open in new tab</button>
    </div>

    <h4>Base64 (data URL)</h4>
    <pre id="base64Box"></pre>
  </div>

  <script>
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const qrStringEl = document.getElementById('qrString');
    const sizeEl = document.getElementById('size');
    const formatEl = document.getElementById('format');
    const resultWrap = document.getElementById('result');
    const qrImg = document.getElementById('qrImg');
    const base64Box = document.getElementById('base64Box');
    const downloadBtn = document.getElementById('downloadBtn');
    const copyBtn = document.getElementById('copyBtn');
    const openNewTabBtn = document.getElementById('openNewTabBtn');

    function arrayBufferToBase64(buffer) {
      // convert ArrayBuffer to base64 string
      let binary = '';
      const bytes = new Uint8Array(buffer);
      const chunkSize = 0x8000;
      for (let i = 0; i < bytes.length; i += chunkSize) {
        const chunk = bytes.subarray(i, i + chunkSize);
        binary += String.fromCharCode.apply(null, chunk);
      }
      return btoa(binary);
    }

    generateBtn.addEventListener('click', async () => {
      const data = qrStringEl.value.trim();
      if (!data) return alert('Masukkan QR string terlebih dahulu.');
      const size = sizeEl.value;
      const fmt = formatEl.value || 'png';

      // GoQR / api.qrserver endpoint
      const endpoint = `https://api.qrserver.com/v1/create-qr-code/?size=${encodeURIComponent(size)}&data=${encodeURIComponent(data)}&format=${encodeURIComponent(fmt)}`;

      try {
        // For PNG we fetch binary; for SVG we can fetch text and directly use SVG data URL
        if (fmt === 'svg') {
          const resp = await fetch(endpoint);
          if (!resp.ok) throw new Error('Gagal generate SVG: ' + resp.status);
          const svgText = await resp.text();
          const dataUrl = 'data:image/svg+xml;utf8,' + encodeURIComponent(svgText);
          qrImg.src = dataUrl;
          base64Box.textContent = dataUrl;
          resultWrap.style.display = 'block';
        } else {
          const resp = await fetch(endpoint);
          if (!resp.ok) throw new Error('Gagal generate image: ' + resp.status);
          const buffer = await resp.arrayBuffer();
          const b64 = arrayBufferToBase64(buffer);
          const dataUrl = 'data:image/png;base64,' + b64;
          qrImg.src = dataUrl;
          base64Box.textContent = dataUrl;
          resultWrap.style.display = 'block';

          // download button prepare
          downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = 'qris.png';
            document.body.appendChild(a);
            a.click();
            a.remove();
          };

          copyBtn.onclick = async () => {
            try {
              await navigator.clipboard.writeText(dataUrl);
              copyBtn.textContent = 'Copied!';
              setTimeout(()=> copyBtn.textContent = 'Copy data:image/png;base64', 1500);
            } catch(e) {
              alert('Gagal copy. Browser mungkin tidak izinkan clipboard API.');
            }
          };

          openNewTabBtn.onclick = () => {
            const w = window.open();
            if (!w) return alert('Pop-up blocked. Izinkan pop-up untuk membuka tab baru.');
            w.document.write('<img src="' + dataUrl + '" alt="QR"/>');
          };
        }

      } catch (err) {
        alert('Error: ' + err.message);
        console.error(err);
      }
    });

    clearBtn.addEventListener('click', () => {
      resultWrap.style.display = 'none';
      qrImg.src = '';
      base64Box.textContent = '';
    });
  </script>
</body>
</html>
